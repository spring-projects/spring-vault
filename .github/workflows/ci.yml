name: CI Build

on:
  push:
    branches: [ main, 3.2.x, 3.1.x ]

permissions: read-all

jobs:
  build:
    name: Build project
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - name: Set up Java
      uses: actions/setup-java@v5
      with:
        java-version: '25'
        distribution: temurin
        cache: maven
    - name: Cache Vault
      uses: actions/cache@v4.3.0
      with:
        path: |
          download
          vault
        key: ${{ runner.os }}-${{ hashFiles('src/test/bash/**') }}
    - name: Setup Vault
      run:  src/test/bash/start.sh
    - name: Build
      run: ./mvnw -B -U clean verify
    - name: Deploy to Artifactory
      if: ${{ github.repository == 'spring-projects/spring-vault' }}
      env:
        ARTIFACTORY_USR: ${{ secrets.ARTIFACTORY_USERNAME }}
        ARTIFACTORY_PSW: ${{ secrets.ARTIFACTORY_PASSWORD }}
        BUILD_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        BUILD_NUMBER: "${{ github.run_number }}"
      run: ci/deploy-artifactory.sh
